<% _vendor_printer_models_cache = Hash.new %>  

<h1>Toner</h1>

<%= horizontal_form_for(@toner_model) do |toner_model| %>
  <%= toner_model.dm_error_notification %>  

  <div id="details">
    <%= toner_model.association :vendor, hint: link_to("Aggiungi una nuova marca all'elenco", new_vendor_path) %>  
    <%= toner_model.input :name %>  
  </div>

  <div id="printer_models_checkbox">
    <h2>Stampanti compatibili</h2>
    <div class="vendor">
      <p class="title">Marca</p>
      <ul>
        <% Vendor.order(:name).each do |vendor| %>    
          <% _vendor_printer_models_cache[vendor] = vendor.printer_models.all %>  
          <% if _vendor_printer_models_cache[vendor].size > 0 %>  
            <li><%= link_to vendor, "#", id: vendor.id %> </li>
          <% end %>
        <% end %>
      </ul>
    </div>
    <div class="model">
      <p class="title">Modelli</p>
      <div id="models">
        <% Vendor.order(:name).each do |vendor| %>
          <% models = vendor.printer_models %>  
          <% unless models.empty?  %>  
            <div class="vendor_group" id="vendor<%= vendor.id %>">
              <p><%= vendor %></p>
              <%= toner_model.association :printer_models, collection: _vendor_printer_models_cache[vendor], as: :check_boxes, label: false %>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>

  <%= toner_model.submit 'Salva' %>
<% end %>

<%= javascript_tag do %>  
  <%= render partial: 'printer_models', formats: :js %>  
<% end %>
